# DLMTOOL OPERATING MODEL {#app:dlmtool-om}

<!-- *A summary of the important features of the DLMtool operating model* -->

<!-- *Draw on appendix of DLMtool paper but simplified to have one region* -->

<!-- *Not too many details; reference the paper* -->

The full operating model with many parameters varying by year, multiple subareas, and additional possible parameterizations is described in the appendices of @carruthers2018. Here we summarize a simplified version that represents a model sufficiently complex to represent most base models in the framework. In particular, we don't express parameters as varying through time where we have recommended that they be treated as fixed through time as provisional starting points. Wherever possible, we follow the notation conventions used in @carruthers2018 for consistency.

**The following is preliminary and largely reproduced from the DLMtool paper [@carruthers2018] appendix for completeness with some modifications. Equation numbers will be added.**

## POPULATION DYNAMICS MODEL  {#sec:dlmtool-pop-dynamics}

<!-- Last historical year, the ``current'' year is denoted by $c$. -->

The DLMtool population dynamics model is an age-structured model. The numbers of fish $N$ in consecutive years $y$ are
calculated from those from the previous year and age class $a$,
subject to the instantaneous mortality rate $Z$:

$$
N_{y + 1,a + 1} = N_{a}e^{- Z_{a}} .
$$

Numbers-at-age are initialized in the first historical year using unfinished recruitment \({{R}}_{0}\) as:

$$
N_{1,a} = {{R}}_{0}\ e^{\sum_{i = 1}^{a}M_{i}}\ \cdot \varepsilon_{R,y - a}.
$$

Fish older than the maximum age $n_a$ are assumed to die. Total mortality rate $Z$ is the sum of natural mortality ($M$) and fishing mortality ($F$) rates:

$$
Z_{a} = M + F_{a}.
$$

Fishing mortality rate ($F$) calculations are included in TODO.

The operating model assumes that growth follows a von Bertalanffy model:

$$
L_{y,a} = L_{\infty}\left( 1 - \exp( - \kappa(a - t_{0} \right)),
$$

where ${\kappa}$ represents the growth rate, $L_{\infty}$ represents the maximum length and $t_0$ represents the theoretical age where length is zero.

The operating model specifies maturity according to length
and a logistic model with parameters for the length at 50% maturity ($\theta_{l50}$) and the length increment to 95% maturity ($\theta_{l50-95}$). Maturity-at-length ($m_l$) is then calculated as:

$$
m_{l} = \frac{1}{1 + e^{{- \ln}19\left( \frac{l - \mathrm{\Delta}_{l50} \cdot L_{\infty}}{{{\theta}}_{l50-95}} \right)}},
$$

and maturity-at-age is calculated using the length-at-age:

$$
m_{a} = \frac{1}{1 + e^{{- \ln}19\left( \frac{a - \theta_{a50}}{\theta_{a95} - \theta_{a50}} \right)}}
$$

where \(\theta_{a50}\) and \(\theta_{a95}\) represent the age at 50% and 95% vulnerability given by the inverse von-Bertalanffy growth curve:

$$
\theta_{a50} = \frac{- \ln\left( 1 - \mathrm{\Delta}_{l50} \right)}{\kappa} + t_{0}
$$

$$
\theta_{a95} = \frac{- \ln\left( 1 - \left( \mathrm{\Delta}_{l50} + \frac{{{\theta}}_{l50\_ 95}}{L_{\infty}} \right) \right)}{\kappa} + t_{0}
$$
The number of fish recruited to the first age group each year $N_{y,a=1}$
is calculated using a Beverton-Holt stock-recruitment relationship with
lognormal recruitment deviations $\varepsilon_{R,y}$ (Table App.
C.2):

$$
N_{y + 1, a = 1} = \left( \frac{4 {h} R_{0,r} S_{y,r}} {S_{0,r}  \left( 1 - {h} \right) + \left( 5{h} - 1 \right) S_{y,r}} \right) \cdot \varepsilon_{R,y},
$$

where the spawning biomass $S$ in a given year is the
sum of the spawning biomass over ages of the maturity at age $m_a$, weight at age
$W_a$, and numbers at age $N_{y,a}$:

$$
S_{y} = \sum_{a = 1}^{n_{a}}{m_{a}W_{a}N_{y,a}}.
$$

Unfished spawning biomass
\(S_{0}\) is calculated from unfished recruitment
\({{R}}_{0}\) and survival to age $a$:

$$
S_{0} = \sum_{a = 1}^{n_{a}}{m_{a}\ W_{a}{\ {R}}_{0}\ e^{\sum_{i = 1}^{a}M_{i}}}.
$$

Weight-at-age ($W_a$) is then assumed to be related to length-at-age ($L_a$) by:

$$
W_{y,a} = \beta_{W}\ {L_{a}}^{\alpha_{W}}.
$$

The recruitment deviations are generated by first sampling from a lognormal distribution with mean $1$ and standard deviation \({{\sigma}}_{R}\):

$$
{\dot{\varepsilon}}_{R,y}\sim \mathrm{Lognormal}\left( 1,{{\sigma}}_{R} \right),
$$

and to these initial draws ($\dot{\varepsilon}_{R,y}$), temporal autocorrelation is added as:

$$
\varepsilon_{R,y} = {{\theta}}_{\textrm{AC}}{\ \dot{\varepsilon}}_{R,y - 1} + {\ \dot{\varepsilon}}_{R,y}\sqrt{\left( 1 - {{{\theta}}_{\textrm{AC}}}^{2} \right)},
$$

where $\theta_{\mathrm{AC}}$ represents a first-order autocorrelation term.

## FISHING DYNAMICS {#sec:dlmtool-fishing-dynamics}

TODO: reword some of this!

Fishing mortality rate $F$ is calculated according to a catchability coefficient, annual effort $E$, age-selectivity $s$, the retention rate (probability of retaining a fish given it is caught) and $R$ the discard mortality rate $\theta_{M \textrm{disc}}$ (fraction of released fish that die):

$$
F_{y,a} = q E_y  s_{a} \left( R_{a} + \ \left( 1 - R_{a} \right)\ {\theta}_{M \textrm{disc}} \right).
$$

The catchability coefficient is calculated by numerical optimization such that stock depletion in the current year matches user-specified depletion \(D\) (spawning biomass relative to unfished levels):

$$
q = \textrm{opt}\left( D\ \vert \ E_{y}, s_{a}, R_{a}, {\theta}_{M \textrm{disc}}, M, {h}, W \right).
$$

The overall retention rate at age $R_a$, is a combination of an age-specific retention $r$ with a maximum value of $1$, and a constant rate of discarding \(\gamma\):

$$
R_{a} = r_{a}\ (1 - \gamma).
$$

Vulnerable biomass is the product of numbers $N$, weight $W$, and age selectivity $s$:

$$
V_{y} = \sum_{a = 1}^{n_{a}}N_{y,a}W_{a} s_{a}.
$$

The vulnerability-at-age $s_{a}$ is calculated from a double-normal selectivity curve and length-at-age:

TODO

<!-- s_{y,a} = \left\{ \begin{matrix} -->
<!-- 2^{- \ \frac{{(L_{y,a} - {\widetilde{L}}_{\textrm{smax}})}^{2}}{\sigma_{\textrm{sasc}}^{2}}} & L_{y,a} \leq {\widetilde{L}}_{\textrm{smax}} \\ -->
<!-- 2^{- \ \frac{{(L_{y,a} - {\widetilde{L}}_{\textrm{smax}})}^{2}}{\sigma_{\textrm{sdesc}}^{2}}} & L_{y,a} > {\widetilde{L}}_{\textrm{smax}} \\ -->
<!-- \end{matrix} \right -->

The length at maximum selectivity \(L_{\textrm{smax}}\) is
defined in the OM (Table App.D.1). The standard deviation parameters of the
ascending limb is given by user-specified length at 5%
vulnerability \({L}_{5}\):

$$
\sigma_{\textrm{sasc}}^{2} = \frac{{{L}}_{5} - {{L}}_{\textrm{smax}}}{\sqrt{- \log_{2^{0.05}}}}
$$

While the standard deviation of the descending limb is given by user-specified vulnerability \({V}_{\overline{L}} \) of fish of
length \(\overline{L}\):

$$
\sigma_{\textrm{sdesc}}^{2} = \frac{\overline{L} - {{L}}_{\textrm{smax}}}{\sqrt{- \log_{2^{{{V}}_{\overline{L}}}}}}
$$

Age-specific retention $r$, is modelled using the same double-normal curve as selectivity:

TODO
<!-- \(r_{y,a} = \left\{ \begin{matrix} -->
<!-- 2^{- \ \frac{{(L_{y,a} - {\widetilde{L}}_{\textrm{rmax}})}^{2}}{\sigma_{\textrm{rasc}}^{2}}} & L_{y,a} \leq {\widetilde{L}}_{\textrm{rmax}} \\ -->
<!-- 2^{- \ \frac{{(L_{y,a} - {\widetilde{L}}_{\textrm{rmax}})}^{2}}{\sigma_{\textrm{rdesc}}^{2}}} & L_{y,a} > {\widetilde{L}}_{\textrm{rmax}} \\ -->
<!-- \end{matrix} \right.\ \) -->


The length at maximum retention \({L}_{\textrm{rmax}}\) is
user-specified. The standard deviation parameters of the
ascending limb is given by user-specified length at 5% retention
\({r}_{5}\):

$$
\sigma_{\textrm{rasc}}^{2} = \frac{{{r}}_{5} - {L}_{\textrm{rmax}}}{\sqrt{- \log_{2^{0.05}}}}
$$

While the standard deviation of the descending limb is given by
user-specified retention \({{r}}_{\overline{L}} \) of fish of
length \(\overline{L}\):

$$
\sigma_{\textrm{rdesc}}^{2} = \frac{\overline{L} - {{L}}_{\textrm{rmax}}}{\sqrt{- \log_{2^{{{r}}_{\overline{L}}}}}}
$$

In historical simulations, catch in numbers $C$ are calculated
using the Baranov equation:

$$
C_{y,a} = N_{y,a}\left( 1 - e^{- Z_{y,a}} \right) \frac{E_{y} s_{a} R_{a}\ }{Z_{y,a}}.
$$

In projected years when TACs are recommended by MPs, the equations are reversed and fishing mortality rates are calculated from prescribed catches. To distribute catches over ages it is first necessary to calculate the distribution of vulnerable biomass (post retention because this is used to distribute landings) across ages:

$$
{\dot{V}}_{y,a} = N_{y,a} W_{a} s_{a} R_{a}.
$$

The realized catches \(\dot{C}\ \) are the TAC recommendations accounting
for implementation error in the TAC $I_\textrm{TAC}$ (see TODO for the implementation error equations), retention rates $R$ and post-release mortality rate $\theta_{M{\textrm{disc}}}$:

$$
\dot{C}_{y,a} = \frac{{\dot{V}}_{y,a}} {\sum_{a}^{n_{a}}{\dot{V}}_{y,a}}
\textrm{TAC}_{\mathrm{MP},y}\ I_{\mathrm{TAC},y}\
\frac{R_{y,a} + \left( 1 - R_{a} \right)
{{\theta}}_{\textrm{Mdisc}}}{R_{a}}
$$

Fishing mortality rates are then calculated from these realized catches
subject to the constraint that they do not exceed user-specified
${F_\textrm{max}}$:

$$
F_{y,a} = \min \left( - \ln\left( 1 - \frac{{\dot{C}}_{y,a}}{N_{y,a}{W}_{a}} \right),F_{\max} \right).
$$

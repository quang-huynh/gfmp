\clearpage

# MANAGEMENT PROCEDURE SCREENING

Objectives:

1. Get down to a manageable number of MPs to describe at this review meeting and future review meetings.
1. Reduce computational burden by excluding MPs that are unlikely to work well for us.

We started with all of the output-control MPs currently in DLMtool (Table \@ref(tab:screening-table)).
We excluded any MPs that required current estimates of abundance, recent age composition data, or a current estimate of depletion because these would not be available for the stocks for which this framework will apply.

We then downloaded all British Colombia groundfish operating models in the [DLMtool library](https://www.datalimitedtoolkit.org/fishery_library/). We used them as entered in the library with the following exceptions:

1. In some cases we adjusted the survey CVs to better match the values displayed in the latest groundfish synopsis report (Pacific Ocean Perch = 0.20 to 0.35, Arrowtooth Flounder = 0.15 to 0.25). We expected this to be an important parameter given that many of the MPs rely on a survey index.
1. We standardized the CV on the catch observations across the stocks to be 0.05 to 0.10 (i.e., quite low).
1. We standardized the bias in catch observations from iteration to iteration to be 0.05 (i.e., quite low.
1. We standardized to the assessment frequency to be every five years.

We ran 100 simulation iterations for each stock with a 50-year projection.  We then calculated the following performance metrics (PMs):

1. PNOF: Probability of not overfishing P(F < F~FMSY~) (years 1--50)
1. P100: Probability SB > SB~MSY~ (years 1--50)
1. P40: Probability SB > 0.4 SB~MSY~ (years 1--50)
1. LTY: Probability yield > 0.5 MSY (years 41--50)
1. AAVY: Probability AAVY (average annual variability in yield) > 0.2

In order to eliminate MPs that did not consistently perform well across multiple stocks, we used the following filtering process:

1. Eliminate MPs with scaled P40 < 0.8 maximum P40 for each stock.
1. Eliminate MPs with scaled P100 < 0.5 maximum P100 for each stock.
1. Eliminate MPs with scaled PNOF < 0.5 maximum PNOF for each stock.
1. Eliminate MPs with scaled LTY < 0.5 maximum LTY for each stock.
1. Order by LTY and retain the top 10 MPs per stock if more than 10 remain.

*FIXME: Obviously these thresholds and this approach is up for debate. This is just a first pass.*

*FIXME: An alternative approach would be based on absolute performance metrics, but we would have to give some thought about what to do in the case of Yelloweye Rockfish, which is quite depleted.*

```{r screening-top-top}
top_pm <- readRDS(here::here("generated-data/top-mp-screening.rds"))
```

```{r screening-top-table, results='asis'}
library(dplyr)
top_mps <- group_by(top_pm, mp) %>% 
  summarize(n = n()) %>% 
  arrange(-n, mp) %>% 
  rename(MP = mp, `Number of stocks` = n)
csasdown::csas_table(top_mps, caption = "Management procedures (MPs) that made it through the initial screening process for at least one stock.")
```

```{r screening-get-top-names}
top_top_pm_names <- names(table(top_pm$mp))[table(top_pm$mp) > 1L]
```

`r nrow(top_mps)` MPs made it through the above filtering process (Table \@ref(tab:screening-top-table)). We then retained only those that made it through the filtering process for at least two stocks. The resulting MPs were `r top_top_pm_names`: (Fig. \@ref(fig:screening-radar-all))  Fig. \@ref(fig:screening-trade-off1) Fig. \@ref(fig:screening-trade-off2) Fig. \@ref(fig:screening-trade-off3).

*FIXME: try adding a surplus production model from MSEtool and optionally substitute the delay difference model from that package too.*

The current top MPs:

IT5: An index target MP where the TAC is modified according to current index levels (mean index over last 5 years) relative to a target level.

ITM: An index target MP where the TAC is modified according to current index levels (mean index over last number of years determined by natural mortality (M)) relative to a target level.

SB2: An MP that makes incremental adjustments to TAC recommendations based on index levels relative to target levels (BMSY/B0) and catch levels relative to target levels (MSY).

GB_target: An MP similar to SBT2 that modifies a time-series of catch recommendations and aims for target catch rate and catch level based on BMSY/B0 and MSY, respectively.

GB_CC: A simple MP that aims for a reference catch (as a proxy for MSY) subject to imperfect information.

DD: Delay difference

DD: Delay difference with a 4010 rule. We could tweak the harvest control rule to perhaps put it more inline with the Canadian precautionary approach.

```{r screening-radar-all, fig.cap="Radar plots of performance metrics across screened management procedures.", fig.pos="H"}
knitr::include_graphics(here::here("report/figure/screening-radar.pdf"))
```

```{r}
library(ggplot2)
library(dplyr)
species_names <- tibble(species = c("pop", "rgh", "srt", "yel", "arr"),
  species_full = c("pacific ocean perch", "rougheye rockfish", "shortspine thornyhead",
    "yelloweye rockfish", "arrowtooth flounder"))
plot_pm <- function(x, y, colour) {
  wide_pm %>%
    left_join(species_names, by = "species") %>%
    filter(mp %in% top_top_pm_names | class == "Reference" | mp %in% c("DD", "AvC")) %>%
    ggplot(aes_string(x = x, y = y)) +
    geom_point(aes_string(colour = colour, shape = "class")) +
    xlim(0, 1) + ylim(0, 1) +
    facet_wrap(~species_full) +
    ggrepel::geom_text_repel(aes_string(label = "mp", colour = colour)) +
    scale_color_viridis_c(direction = -1) +
    scale_shape_manual(values = c("Reference" = 4, "Output" = 21)) +
    gfplot::theme_pbs()
}
wide_pm <- readRDS(here::here("generated-data/wide-pm-screening.rds"))
```

```{r screening-trade-off1, fig.cap="Performance trade-offs 1"}
plot_pm("P100", "LTY", "AAVY")
```

```{r screening-trade-off2, fig.cap="Performance trade-offs 2"}
plot_pm("P40", "LTY", "PNOF")

```

```{r screening-trade-off3, fig.cap="Performance trade-offs 3"}
plot_pm("P100", "PNOF", "LTY")
```

\clearpage 

```{r screening-table}
library(dplyr)
table_screening <- readr::read_csv(here::here("report/data/dlmtool-mps.csv")) %>% 
  select(-Comment) %>% 
  mutate(Candidate = ifelse(Candidate == "Y", "Yes", "No")) %>% 
  mutate(`Reason for exclusion` = 
      ifelse(is.na(`Reason for exclusion`), "", `Reason for exclusion`))

table_screening$`Management Procedure` <- 
  sapply(table_screening$`Management Procedure`, function(x) {
  paste(paste0("\\texttt{", strsplit(x, " ")[[1]], "}"), collapse = " ")
})

table_screening$`Management Procedure` <- gsub("\\_", "\\\\_", table_screening$`Management Procedure`)

knitr::kable(table_screening,
  caption = "Test",
  booktabs = TRUE,
  longtable = TRUE,
  linesep = "\\addlinespace",
  escape = FALSE,
  format = "latex") %>%
  kableExtra::column_spec(column = 1, width = "4cm") %>% 
  kableExtra::column_spec(column = 2, width = "5.5cm") %>% 
  kableExtra::column_spec(column = 4, width = "3.5cm") %>% 
  kableExtra::kable_styling(latex_options = "repeat_header", 
    repeat_header_text = "", repeat_header_method = "replace") %>% 
  sub("\\caption\\[\\]\\{\\}", "\\caption*{}", .)
```
